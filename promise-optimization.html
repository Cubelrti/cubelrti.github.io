<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise Optimization | Cubelrti&#39;s Blog</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/assets/css/0.styles.854efcde.css" as="style"><link rel="preload" href="/assets/js/app.f42c0b44.js" as="script"><link rel="preload" href="/assets/js/31.bc58c029.js" as="script"><link rel="prefetch" href="/assets/js/10.516d8242.js"><link rel="prefetch" href="/assets/js/11.c36dcbcb.js"><link rel="prefetch" href="/assets/js/12.e895b184.js"><link rel="prefetch" href="/assets/js/13.ec7be9a7.js"><link rel="prefetch" href="/assets/js/14.54d29f87.js"><link rel="prefetch" href="/assets/js/15.e407cc44.js"><link rel="prefetch" href="/assets/js/16.db49905b.js"><link rel="prefetch" href="/assets/js/17.736569b1.js"><link rel="prefetch" href="/assets/js/18.1a4266aa.js"><link rel="prefetch" href="/assets/js/19.fab2abb6.js"><link rel="prefetch" href="/assets/js/2.ce88158f.js"><link rel="prefetch" href="/assets/js/20.556d670c.js"><link rel="prefetch" href="/assets/js/21.dc368674.js"><link rel="prefetch" href="/assets/js/22.5febb538.js"><link rel="prefetch" href="/assets/js/23.a8022afa.js"><link rel="prefetch" href="/assets/js/24.12852a72.js"><link rel="prefetch" href="/assets/js/25.5a2f1e7f.js"><link rel="prefetch" href="/assets/js/26.d78beae1.js"><link rel="prefetch" href="/assets/js/27.5cdcdcdf.js"><link rel="prefetch" href="/assets/js/28.4adfd5ba.js"><link rel="prefetch" href="/assets/js/29.a67dfb0b.js"><link rel="prefetch" href="/assets/js/3.2891e7af.js"><link rel="prefetch" href="/assets/js/30.52bb0b17.js"><link rel="prefetch" href="/assets/js/32.c32f2855.js"><link rel="prefetch" href="/assets/js/33.353142fa.js"><link rel="prefetch" href="/assets/js/34.37af366f.js"><link rel="prefetch" href="/assets/js/35.9bbb247e.js"><link rel="prefetch" href="/assets/js/36.dcd775a7.js"><link rel="prefetch" href="/assets/js/37.7a866a32.js"><link rel="prefetch" href="/assets/js/38.402538ca.js"><link rel="prefetch" href="/assets/js/39.536dee2f.js"><link rel="prefetch" href="/assets/js/4.079b915f.js"><link rel="prefetch" href="/assets/js/40.53a05fc2.js"><link rel="prefetch" href="/assets/js/41.e99a5f5e.js"><link rel="prefetch" href="/assets/js/42.74be2de5.js"><link rel="prefetch" href="/assets/js/43.6a321652.js"><link rel="prefetch" href="/assets/js/44.254475de.js"><link rel="prefetch" href="/assets/js/45.bea33be6.js"><link rel="prefetch" href="/assets/js/46.c1408df5.js"><link rel="prefetch" href="/assets/js/47.74ba1c55.js"><link rel="prefetch" href="/assets/js/48.91bdc6a5.js"><link rel="prefetch" href="/assets/js/49.b8e75933.js"><link rel="prefetch" href="/assets/js/5.b2c7c0bf.js"><link rel="prefetch" href="/assets/js/50.efea2307.js"><link rel="prefetch" href="/assets/js/51.174b1c37.js"><link rel="prefetch" href="/assets/js/52.fd97caa2.js"><link rel="prefetch" href="/assets/js/6.632b27cc.js"><link rel="prefetch" href="/assets/js/7.b2cab865.js"><link rel="prefetch" href="/assets/js/8.5c5f6195.js"><link rel="prefetch" href="/assets/js/9.ad4020c1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.854efcde.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Cubelrti's Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://cubelrti.github.io/resume/en/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Resume
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="https://cubelrti.github.io/resume/en/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Resume
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/async-iteration.html" class="sidebar-link">Async Iteration</a></li><li><a href="/bit-manupulation.html" class="sidebar-link">Bit Manupulation</a></li><li><a href="/css-framework-think.html" class="sidebar-link">CSS Framework Think</a></li><li><a href="/css-scrollbars.html" class="sidebar-link">CSS Scrollbars</a></li><li><a href="/darknet-cv2.html" class="sidebar-link">DarkNet &amp; CV2</a></li><li><a href="/event-emitter.html" class="sidebar-link">Event Emitter</a></li><li><a href="/framework-analysis.html" class="sidebar-link">Framework Analysis</a></li><li><a href="/front-end-design-pattern.html" class="sidebar-link">Front-End Design Patterns</a></li><li><a href="/front-end-interview.html" class="sidebar-link">Front-End Interview</a></li><li><a href="/hairline-css.html" class="sidebar-link">Hairline CSS</a></li><li><a href="/image-orientation.html" class="sidebar-link">Image Orientation</a></li><li><a href="/indexed-db.html" class="sidebar-link">IndexedDB Cheatsheet</a></li><li><a href="/intersection-observer.html" class="sidebar-link">Intersection Observer</a></li><li><a href="/javascript-extend.html" class="sidebar-link">Extend in Javascript</a></li><li><a href="/javascript-trending.html" class="sidebar-link">Javascript Trending</a></li><li><a href="/lambda-functions.html" class="sidebar-link">Lambda Expressions</a></li><li><a href="/lazy-load.html" class="sidebar-link">Lazy Load on Web</a></li><li><a href="/lowdb-101.html" class="sidebar-link">LowDB Code Reading</a></li><li><a href="/material-ripple.html" class="sidebar-link">Material Ripple</a></li><li><a href="/modular-javascript.html" class="sidebar-link">Modular Javascript</a></li><li><a href="/node-reverse-proxy.html" class="sidebar-link">Node Reverse Proxy</a></li><li><a href="/nodejs-data-persistence.html" class="sidebar-link">NodeJS Data Persistence</a></li><li><a href="/npm-security.html" class="sidebar-link">NPM Security</a></li><li><a href="/object-creation.html" class="sidebar-link">Object Prototype Extending</a></li><li><a href="/openapi-cheatsheet.html" class="sidebar-link">OpenAPI Cheatsheet</a></li><li><a href="/overcoming-inituition-in-programming.html" class="sidebar-link">Programming Intuition</a></li><li><a href="/pixijs-101.html" class="sidebar-link">PixiJS 101</a></li><li><a href="/promise-optimization.html" class="active sidebar-link">Promise Optimization</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/promise-optimization.html#å¼‚æ­¥ç¼–ç¨‹çš„æ–°æ–¹æ¡ˆ" class="sidebar-link">å¼‚æ­¥ç¼–ç¨‹çš„æ–°æ–¹æ¡ˆ</a></li><li class="sidebar-sub-header"><a href="/promise-optimization.html#async-æ€§èƒ½ä¼˜åŒ–" class="sidebar-link">async æ€§èƒ½ä¼˜åŒ–</a></li><li class="sidebar-sub-header"><a href="/promise-optimization.html#å¼€å‘ä½“éªŒä¼˜åŒ–" class="sidebar-link">å¼€å‘ä½“éªŒä¼˜åŒ–</a></li><li class="sidebar-sub-header"><a href="/promise-optimization.html#ç»“è®º" class="sidebar-link">ç»“è®º</a></li></ul></li><li><a href="/prototype-review.html" class="sidebar-link">Prototype Review</a></li><li><a href="/python-asyncio.html" class="sidebar-link">Python asyncio</a></li><li><a href="/react-fiber.html" class="sidebar-link">React Fiber</a></li><li><a href="/redux-saga.html" class="sidebar-link">Redux Saga</a></li><li><a href="/rust-101.html" class="sidebar-link">Rust 101</a></li><li><a href="/throttle-and-debounce.html" class="sidebar-link">Throttle and Debounce</a></li><li><a href="/typescript-and-node.html" class="sidebar-link">TypeScript and Node</a></li><li><a href="/typescript-and-react.html" class="sidebar-link">Typescript and React</a></li><li><a href="/undefined-in-javascript.html" class="sidebar-link">Undefined in Javascript</a></li><li><a href="/v8-async.html" class="sidebar-link">V8 Async</a></li><li><a href="/v8-sorting.html" class="sidebar-link">V8 Sorting</a></li><li><a href="/v8-torque.html" class="sidebar-link">V8 Torque</a></li><li><a href="/variable-length-curring.html" class="sidebar-link">Variable Length Curring</a></li><li><a href="/vue-impl-01.html" class="sidebar-link">Vue Implementation 01</a></li><li><a href="/vue-impl-02.html" class="sidebar-link">Vue Implementation 02</a></li><li><a href="/vue-impl-03.html" class="sidebar-link">Vue Implementation 03</a></li><li><a href="/vuex-typescript.html" class="sidebar-link">Vuex Typescript</a></li><li><a href="/webrtc-practice.html" class="sidebar-link">WebRTC Practice</a></li><li><a href="/websocket-practice.html" class="sidebar-link">Websocket Practice</a></li><li><a href="/webworker-caveats.html" class="sidebar-link">WebWorker Caveats</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="promise-optimization"><a href="#promise-optimization" aria-hidden="true" class="header-anchor">#</a> Promise Optimization</h1> <p><img src="https://img.alicdn.com/tfs/TB1XkgupxjaK1RjSZKzXXXVwXXa-800-450.png" alt="image | left">
ç¿»è¯‘è‡ªï¼š<a href="https://v8.dev/blog/fast-async" target="_blank" rel="noopener noreferrer">Faster async functions and promises<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
JavaScript çš„å¼‚æ­¥è¿‡ç¨‹ä¸€ç›´è¢«è®¤ä¸ºæ˜¯ä¸å¤Ÿå¿«çš„ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ï¼Œåœ¨ NodeJS ç­‰å®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ä¸‹è°ƒè¯•å ªæ¯”å™©æ¢¦ã€‚ä¸è¿‡ï¼Œè¿™ä¸€åˆ‡æ­£åœ¨æ”¹å˜ï¼Œè¿™ç¯‡æ–‡ç« ä¼šè¯¦ç»†è§£é‡Šæˆ‘ä»¬æ˜¯å¦‚ä½•ä¼˜åŒ– V8 å¼•æ“ï¼ˆä¹Ÿä¼šæ¶‰åŠä¸€äº›å…¶å®ƒå¼•æ“ï¼‰é‡Œçš„ async å‡½æ•°å’Œ promises çš„ï¼Œä»¥åŠä¼´éšç€çš„å¼€å‘ä½“éªŒçš„ä¼˜åŒ–ã€‚
<strong>æ¸©é¦¨æç¤ºï¼š</strong> è¿™é‡Œæœ‰ä¸ª <a href="https://www.youtube.com/watch?v=DFP5DKDQfOc" target="_blank" rel="noopener noreferrer">è§†é¢‘<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œä½ å¯ä»¥ç»“åˆç€æ–‡ç« çœ‹ã€‚</p> <h2 id="å¼‚æ­¥ç¼–ç¨‹çš„æ–°æ–¹æ¡ˆ"><a href="#å¼‚æ­¥ç¼–ç¨‹çš„æ–°æ–¹æ¡ˆ" aria-hidden="true" class="header-anchor">#</a> å¼‚æ­¥ç¼–ç¨‹çš„æ–°æ–¹æ¡ˆ</h2> <h3 id="ä»-callbacks-åˆ°-promisesï¼Œå†åˆ°-async-å‡½æ•°"><a href="#ä»-callbacks-åˆ°-promisesï¼Œå†åˆ°-async-å‡½æ•°" aria-hidden="true" class="header-anchor">#</a> ä» callbacks åˆ° promisesï¼Œå†åˆ° async å‡½æ•°</h3> <p>åœ¨ promises æ­£å¼æˆä¸º JavaScript æ ‡å‡†çš„ä¸€éƒ¨åˆ†ä¹‹å‰ï¼Œå›è°ƒè¢«å¤§é‡ç”¨åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­ï¼Œä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">validateParams</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dbQuery</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> dbResults<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">serviceCall</span><span class="token punctuation">(</span>dbResults<span class="token punctuation">,</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> serviceResults<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">done</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> serviceResults<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç±»ä¼¼ä»¥ä¸Šæ·±åº¦åµŒå¥—çš„å›è°ƒé€šå¸¸è¢«ç§°ä¸ºã€Œå›è°ƒé»‘æ´ã€ï¼Œå› ä¸ºå®ƒè®©ä»£ç å¯è¯»æ€§å˜å·®ä¸”ä¸æ˜“ç»´æŠ¤ã€‚
å¹¸è¿åœ°æ˜¯ï¼Œç°åœ¨ promises æˆä¸ºäº† JavaScript è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼Œä»¥ä¸‹å®ç°äº†è·Ÿä¸Šé¢åŒæ ·çš„åŠŸèƒ½ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">validateParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>dbQuery<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>serviceCall<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>result <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ€è¿‘ï¼ŒJavaScript æ”¯æŒäº† <a href="https://developers.google.com/web/fundamentals/primers/async-functions" target="_blank" rel="noopener noreferrer">async å‡½æ•°<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œä¸Šé¢çš„å¼‚æ­¥ä»£ç å¯ä»¥å†™æˆåƒä¸‹é¢è¿™æ ·çš„åŒæ­¥çš„ä»£ç ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">validateParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dbResults <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">dbQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">serviceCall</span><span class="token punctuation">(</span>dbResults<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> results<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å€ŸåŠ© async å‡½æ•°ï¼Œä»£ç å˜å¾—æ›´ç®€æ´ï¼Œä»£ç çš„é€»è¾‘å’Œæ•°æ®æµéƒ½å˜å¾—æ›´å¯æ§ï¼Œå½“ç„¶å…¶å®åº•å±‚å®ç°è¿˜æ˜¯å¼‚æ­¥ã€‚ï¼ˆæ³¨æ„ï¼ŒJavaScript è¿˜æ˜¯å•çº¿ç¨‹æ‰§è¡Œï¼Œasync å‡½æ•°å¹¶ä¸ä¼šå¼€æ–°çš„çº¿ç¨‹ã€‚ï¼‰</p> <h3 id="ä»äº‹ä»¶ç›‘å¬å›è°ƒåˆ°-async-è¿­ä»£å™¨"><a href="#ä»äº‹ä»¶ç›‘å¬å›è°ƒåˆ°-async-è¿­ä»£å™¨" aria-hidden="true" class="header-anchor">#</a> ä»äº‹ä»¶ç›‘å¬å›è°ƒåˆ° async è¿­ä»£å™¨</h3> <p>NodeJS é‡Œ <a href="https://nodejs.org/api/stream.html#stream_readable_streams" target="_blank" rel="noopener noreferrer">ReadableStreams<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ä½œä¸ºå¦ä¸€ç§å½¢å¼çš„å¼‚æ­¥ä¹Ÿç‰¹åˆ«å¸¸è§ï¼Œä¸‹é¢æ˜¯ä¸ªä¾‹å­ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    body <span class="token operator">+=</span> chunk<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">1337</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™æ®µä»£ç æœ‰ä¸€ç‚¹éš¾ç†è§£ï¼šåªèƒ½é€šè¿‡å›è°ƒå»æ‹¿ chunks é‡Œçš„æ•°æ®æµï¼Œè€Œä¸”æ•°æ®æµçš„ç»“æŸä¹Ÿå¿…é¡»åœ¨å›è°ƒé‡Œå¤„ç†ã€‚å¦‚æœä½ æ²¡èƒ½ç†è§£åˆ°å‡½æ•°æ˜¯ç«‹å³ç»“æŸä½†å®é™…å¤„ç†å¿…é¡»åœ¨å›è°ƒé‡Œè¿›è¡Œï¼Œå¯èƒ½å°±ä¼šå¼•å…¥ bugã€‚
åŒæ ·å¾ˆå¹¸è¿ï¼ŒES2018 ç‰¹æ€§é‡Œå¼•å…¥çš„ä¸€ä¸ªå¾ˆé…·çš„ <a href="http://2ality.com/2016/10/asynchronous-iteration.html" target="_blank" rel="noopener noreferrer">async è¿­ä»£å™¨<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> å¯ä»¥ç®€åŒ–ä¸Šé¢çš„ä»£ç ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      body <span class="token operator">+=</span> chunk<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">1337</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä½ å¯ä»¥æŠŠæ‰€æœ‰æ•°æ®å¤„ç†é€»è¾‘éƒ½æ”¾åˆ°ä¸€ä¸ª async å‡½æ•°é‡Œä½¿ç”¨ <code>for awaitâ€¦of</code> å»è¿­ä»£ chunksï¼Œè€Œä¸æ˜¯åˆ†åˆ«åœ¨ <code>'data'</code> å’Œ <code>'end'</code> å›è°ƒé‡Œå¤„ç†ï¼Œè€Œä¸”æˆ‘ä»¬è¿˜åŠ äº† <code>try-catch</code> å—æ¥é¿å… <code>unhandledRejection</code> é—®é¢˜ã€‚
ä»¥ä¸Šè¿™äº›ç‰¹æ€§ä½ ä»Šå¤©å°±å¯ä»¥åœ¨ç”Ÿæˆç¯å¢ƒä½¿ç”¨ï¼async å‡½æ•°__ä» Node.js 8 (V8 v6.2 / Chrome 62) å¼€å§‹å°±å·²å…¨é¢æ”¯æŒ__ï¼Œasync è¿­ä»£å™¨__ä» Node.js 10 (V8 v6.8 / Chrome 68) å¼€å§‹æ”¯æŒ__ã€‚</p> <h2 id="async-æ€§èƒ½ä¼˜åŒ–"><a href="#async-æ€§èƒ½ä¼˜åŒ–" aria-hidden="true" class="header-anchor">#</a> async æ€§èƒ½ä¼˜åŒ–</h2> <p>ä» V8 v5.5 (Chrome 55 &amp; Node.js 7) åˆ° V8 v6.8 (Chrome 68 &amp; Node.js 10)ï¼Œæˆ‘ä»¬è‡´åŠ›äºå¼‚æ­¥ä»£ç çš„æ€§èƒ½ä¼˜åŒ–ï¼Œç›®å‰çš„æ•ˆæœè¿˜ä¸é”™ï¼Œä½ å¯ä»¥æ”¾å¿ƒåœ°ä½¿ç”¨è¿™äº›æ–°ç‰¹æ€§ã€‚
<img src="https://img.alicdn.com/tfs/TB1LLxkpxTpK1RjSZFMXXbG_VXa-600-371.svg" alt="image | left">
ä¸Šé¢çš„æ˜¯ <a href="https://github.com/v8/promise-performance-tests/blob/master/lib/doxbee-async.js" target="_blank" rel="noopener noreferrer">doxbee åŸºå‡†æµ‹è¯•<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œç”¨äºååº”é‡åº¦ä½¿ç”¨ promise çš„æ€§èƒ½ï¼Œå›¾ä¸­çºµåæ ‡è¡¨ç¤ºæ‰§è¡Œæ—¶é—´ï¼Œæ‰€ä»¥è¶Šå°è¶Šå¥½ã€‚
å¦ä¸€æ–¹é¢ï¼Œ<a href="https://github.com/v8/promise-performance-tests/blob/master/lib/parallel-async.js" target="_blank" rel="noopener noreferrer">parallel åŸºå‡†æµ‹è¯•<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ååº”çš„æ˜¯é‡åº¦ä½¿ç”¨ <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" target="_blank" rel="noopener noreferrer">Promise.all()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> çš„æ€§èƒ½æƒ…å†µï¼Œç»“æœå¦‚ä¸‹ï¼š
<img src="https://img.alicdn.com/tfs/TB1ShxdpwDqK1RjSZSyXXaxEVXa-600-371.svg" alt="image | left"> <code>Promise.all</code> çš„æ€§èƒ½æé«˜äº†__å…«å€__ï¼
ç„¶åï¼Œä¸Šé¢çš„æµ‹è¯•ä»…ä»…æ˜¯å°çš„ DEMO çº§åˆ«çš„æµ‹è¯•ï¼ŒV8 å›¢é˜Ÿæ›´å…³å¿ƒçš„æ˜¯ <a href="https://v8.dev/blog/real-world-performance" target="_blank" rel="noopener noreferrer">å®é™…ç”¨æˆ·ä»£ç çš„ä¼˜åŒ–æ•ˆæœ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚
<img src="https://img.alicdn.com/tfs/TB1uqJlpAzoK1RjSZFlXXai4VXa-600-371.svg" alt="image | left">
ä¸Šé¢æ˜¯åŸºäºå¸‚åœºä¸Šæµè¡Œçš„ HTTP æ¡†æ¶åšçš„æµ‹è¯•ï¼Œè¿™äº›æ¡†æ¶å¤§é‡ä½¿ç”¨äº† promises å’Œ <code>async</code> å‡½æ•°ï¼Œè¿™ä¸ªè¡¨å±•ç¤ºçš„æ˜¯æ¯ç§’è¯·æ±‚æ•°ï¼Œæ‰€ä»¥è·Ÿä¹‹å‰çš„è¡¨ä¸ä¸€æ ·ï¼Œè¿™ä¸ªæ˜¯æ•°å€¼è¶Šå¤§è¶Šå¥½ã€‚ä»è¡¨å¯ä»¥çœ‹å‡ºï¼Œä» Node.js 7 (V8 v5.5) åˆ° Node.js 10 (V8 v6.8) æ€§èƒ½æå‡äº†ä¸å°‘ã€‚
æ€§èƒ½æå‡å–å†³äºä»¥ä¸‹ä¸‰ä¸ªå› ç´ ï¼š</p> <ul><li><a href="https://v8.dev/docs/turbofan" target="_blank" rel="noopener noreferrer">TurboFan<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œæ–°çš„ä¼˜åŒ–ç¼–è¯‘å™¨ ğŸ‰</li> <li><a href="https://v8.dev/blog/orinoco" target="_blank" rel="noopener noreferrer">Orinoco<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œæ–°çš„åƒåœ¾å›æ”¶å™¨ ğŸš›</li> <li>ä¸€ä¸ª Node.js 8 çš„ bug å¯¼è‡´ await è·³è¿‡äº†ä¸€äº›å¾® tickï¼ˆmicroticksï¼‰ ğŸ›
å½“æˆ‘ä»¬åœ¨ <a href="https://medium.com/the-node-js-collection/node-js-8-3-0-is-now-available-shipping-with-the-ignition-turbofan-execution-pipeline-aa5875ad3367" target="_blank" rel="noopener noreferrer">Node.js 8<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> é‡Œ <a href="https://v8.dev/blog/launching-ignition-and-turbofan" target="_blank" rel="noopener noreferrer">å¯ç”¨ TurboFan<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> çš„åï¼Œæ€§èƒ½å¾—åˆ°äº†å·¨å¤§çš„æå‡ã€‚
åŒæ—¶æˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªæ–°çš„åƒåœ¾å›æ”¶å™¨ï¼Œå«ä½œ Orinocoï¼Œå®ƒæŠŠåƒåœ¾å›æ”¶ä»ä¸»çº¿ç¨‹ä¸­ç§»èµ°ï¼Œå› æ­¤å¯¹è¯·æ±‚å“åº”é€Ÿåº¦æå‡æœ‰å¾ˆå¤§å¸®åŠ©ã€‚
æœ€åï¼ŒNode.js 8 ä¸­å¼•å…¥äº†ä¸€ä¸ª bug åœ¨æŸäº›æ—¶å€™ä¼šè®© <code>await</code> è·³è¿‡ä¸€äº›å¾® tickï¼Œè¿™åè€Œè®©æ€§èƒ½å˜å¥½äº†ã€‚è¿™ä¸ª bug æ˜¯å› ä¸ºæ— æ„ä¸­è¿åäº†è§„èŒƒå¯¼è‡´çš„ï¼Œä½†æ˜¯å´ç»™äº†æˆ‘ä»¬ä¼˜åŒ–çš„ä¸€äº›æ€è·¯ã€‚è¿™é‡Œæˆ‘ä»¬ç¨å¾®è§£é‡Šä¸‹ï¼š</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> p<span class="token punctuation">;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'after:await'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tick:a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tick:b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢ä»£ç ä¸€å¼€å§‹åˆ›å»ºäº†ä¸€ä¸ªå·²ç»å®ŒæˆçŠ¶æ€çš„ promise <code>p</code>ï¼Œç„¶å <code>await</code> å‡ºå…¶ç»“æœï¼ŒåˆåŒæ—¶é“¾äº†ä¸¤ä¸ª <code>then</code>ï¼Œé‚£æœ€ç»ˆçš„ <code>console.log</code> æ‰“å°çš„ç»“æœä¼šæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
å› ä¸º <code>p</code> æ˜¯å·²å®Œæˆçš„ï¼Œä½ å¯èƒ½è®¤ä¸ºå…¶ä¼šå…ˆæ‰“å° <code>'after:await'</code>ï¼Œç„¶åæ˜¯å‰©ä¸‹ä¸¤ä¸ª <code>tick</code>, äº‹å®ä¸Š Node.js 8 é‡Œçš„ç»“æœæ˜¯ï¼š
<img src="https://img.alicdn.com/tfs/TB1H_FhpCzqK1RjSZPcXXbTepXa-959-445.svg" alt="image | left">
è™½ç„¶ä»¥ä¸Šç»“æœç¬¦åˆé¢„æœŸï¼Œä½†æ˜¯å´ä¸ç¬¦åˆè§„èŒƒã€‚Node.js 10 çº æ­£äº†è¿™ä¸ªè¡Œä¸ºï¼Œä¼šå…ˆæ‰§è¡Œ <code>then</code> é“¾é‡Œçš„ï¼Œç„¶åæ‰æ˜¯ async å‡½æ•°ã€‚
<img src="https://img.alicdn.com/tfs/TB1OthqpAvoK1RjSZFNXXcxMVXa-959-445.svg" alt="image | left">
è¿™ä¸ªã€Œæ­£ç¡®çš„è¡Œä¸ºã€çœ‹èµ·æ¥å¹¶ä¸æ­£å¸¸ï¼Œç”šè‡³ä¼šè®©å¾ˆå¤š JavaScript å¼€å‘è€…æ„Ÿåˆ°åƒæƒŠï¼Œè¿˜æ˜¯æœ‰å¿…è¦å†è¯¦ç»†è§£é‡Šä¸‹ã€‚åœ¨è§£é‡Šä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»ä¸€äº›åŸºç¡€å¼€å§‹ã€‚</p> <h3 id="ä»»åŠ¡ï¼ˆtasksï¼‰vs-å¾®ä»»åŠ¡ï¼ˆmicrotasksï¼‰"><a href="#ä»»åŠ¡ï¼ˆtasksï¼‰vs-å¾®ä»»åŠ¡ï¼ˆmicrotasksï¼‰" aria-hidden="true" class="header-anchor">#</a> ä»»åŠ¡ï¼ˆtasksï¼‰vs. å¾®ä»»åŠ¡ï¼ˆmicrotasksï¼‰</h3> <p>ä»æŸå±‚é¢ä¸Šæ¥è¯´ï¼ŒJavaScript é‡Œå­˜åœ¨ä»»åŠ¡å’Œå¾®ä»»åŠ¡ã€‚ä»»åŠ¡å¤„ç† I/O å’Œè®¡æ—¶å™¨ç­‰äº‹ä»¶ï¼Œä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªã€‚å¾®ä»»åŠ¡æ˜¯ä¸ºäº† <code>async</code>/<code>await</code> å’Œ promise çš„å»¶è¿Ÿæ‰§è¡Œè®¾è®¡çš„ï¼Œæ¯æ¬¡ä»»åŠ¡æœ€åæ‰§è¡Œã€‚åœ¨è¿”å›äº‹ä»¶å¾ªç¯ï¼ˆevent loopï¼‰å‰ï¼Œå¾®ä»»åŠ¡çš„é˜Ÿåˆ—ä¼šè¢«æ¸…ç©ºã€‚
<img src="https://img.alicdn.com/tfs/TB1IXhnpxTpK1RjSZFKXXa2wXXa-832-286.svg" alt="image | left">
å¯ä»¥é€šè¿‡ Jake Archibald çš„ <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" target="_blank" rel="noopener noreferrer">tasks, microtasks, queues, and schedules in the browser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> äº†è§£æ›´å¤šã€‚Node.js é‡Œä»»åŠ¡æ¨¡å‹ä¸æ­¤éå¸¸ç±»ä¼¼ã€‚</p> <h3 id="async-å‡½æ•°"><a href="#async-å‡½æ•°" aria-hidden="true" class="header-anchor">#</a> async å‡½æ•°</h3> <p>æ ¹æ® MDNï¼Œasync å‡½æ•°æ˜¯ä¸€ä¸ªé€šè¿‡å¼‚æ­¥æ‰§è¡Œå¹¶éšå¼è¿”å› promise ä½œä¸ºç»“æœçš„å‡½æ•°ã€‚ä»å¼€å‘è€…è§’åº¦çœ‹ï¼Œasync å‡½æ•°è®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ã€‚
ä¸€ä¸ªæœ€ç®€å•çš„ async å‡½æ•°ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">computeAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å‡½æ•°æ‰§è¡Œåä¼šè¿”å›ä¸€ä¸ª promiseï¼Œä½ å¯ä»¥åƒä½¿ç”¨å…¶å®ƒ promise ä¸€æ ·ç”¨å…¶è¿”å›çš„å€¼ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">computeAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// â†’ Promise</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints 42 on the next turn</span>
</code></pre></div><p>ä½ åªèƒ½åœ¨ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œåæ‰èƒ½å¾—åˆ° promise <code>p</code> è¿”å›çš„å€¼ï¼Œæ¢å¥è¯è¯´ï¼Œä¸Šé¢çš„ä»£ç è¯­ä¹‰ä¸Šç­‰ä»·äºä½¿ç”¨ <code>Promise.resolve</code> å¾—åˆ°çš„ç»“æœï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">computeAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>async å‡½æ•°çœŸæ­£å¼ºå¤§çš„åœ°æ–¹æ¥æºäº <code>await</code> è¡¨è¾¾å¼ï¼Œå®ƒå¯ä»¥è®©ä¸€ä¸ªå‡½æ•°æ‰§è¡Œæš‚åœç›´åˆ°ä¸€ä¸ª promise å·²æ¥å—ï¼ˆresolvedï¼‰ï¼Œç„¶åç­‰åˆ°å·²å®Œæˆï¼ˆfulfilledï¼‰åæ¢å¤æ‰§è¡Œã€‚å·²å®Œæˆçš„ promise ä¼šä½œä¸º <code>await</code> çš„å€¼ã€‚è¿™é‡Œçš„ä¾‹å­ä¼šè§£é‡Šè¿™ä¸ªè¡Œä¸ºï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchStatus</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>fetchStatus</code> åœ¨é‡åˆ° <code>await</code> æ—¶ä¼šæš‚åœï¼Œå½“ <code>fetch</code> è¿™ä¸ª promise å·²å®Œæˆåä¼šæ¢å¤æ‰§è¡Œï¼Œè¿™è·Ÿç›´æ¥é“¾å¼å¤„ç† <code>fetch</code> è¿”å›çš„ promise æŸç§ç¨‹åº¦ä¸Šç­‰ä»·ã€‚</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">fetchStatus</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é“¾å¼å¤„ç†å‡½æ•°é‡ŒåŒ…å«äº†ä¹‹å‰è·Ÿåœ¨ <code>await</code> åé¢çš„ä»£ç ã€‚
æ­£å¸¸æ¥è¯´ä½ åº”è¯¥åœ¨ <code>await</code> åé¢æ”¾ä¸€ä¸ª <code>Promise</code>ï¼Œä¸è¿‡å…¶å®åé¢å¯ä»¥è·Ÿä»»æ„ JavaScript çš„å€¼ï¼Œå¦‚æœè·Ÿçš„ä¸æ˜¯ promiseï¼Œä¼šè¢«åˆ¶è½¬ä¸º promiseï¼Œæ‰€ä»¥ <code>await 42</code> æ•ˆæœå¦‚ä¸‹ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> v <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token number">42</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// â†’ Promise</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints `42` eventually</span>
</code></pre></div><p>æ›´æœ‰è¶£çš„æ˜¯ï¼Œ<code>await</code> åå¯ä»¥è·Ÿä»»ä½• <a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">â€œthenableâ€<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œä¾‹å¦‚ä»»ä½•å«æœ‰ <code>then</code> æ–¹æ³•çš„å¯¹è±¡ï¼Œå°±ç®—ä¸æ˜¯ promise éƒ½å¯ä»¥ã€‚å› æ­¤ä½ å¯ä»¥å®ç°ä¸€ä¸ªæœ‰æ„æ€çš„ ç±»æ¥è®°å½•æ‰§è¡Œæ—¶é—´çš„æ¶ˆè€—ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Sleep</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> actualTime <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>actualTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸€èµ·æ¥çœ‹çœ‹ V8 <a href="https://tc39.github.io/ecma262/#await" target="_blank" rel="noopener noreferrer">è§„èŒƒ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> é‡Œæ˜¯å¦‚ä½•å¤„ç† <code>await</code> çš„ã€‚ä¸‹é¢æ˜¯å¾ˆç®€å•çš„ async å‡½æ•° <code>foo</code>ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">await</span> v<span class="token punctuation">;</span>
  <span class="token keyword">return</span> w<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æ‰§è¡Œæ—¶ï¼Œå®ƒæŠŠå‚æ•° <code>v</code> å°è£…æˆä¸€ä¸ª promiseï¼Œç„¶åä¼šæš‚åœç›´åˆ° promise å®Œæˆï¼Œç„¶å <code>w</code> èµ‹å€¼ä¸ºå·²å®Œæˆçš„ promiseï¼Œæœ€å async è¿”å›äº†è¿™ä¸ªå€¼ã€‚</p> <h3 id="ç¥ç§˜çš„-await"><a href="#ç¥ç§˜çš„-await" aria-hidden="true" class="header-anchor">#</a> ç¥ç§˜çš„ <code>await</code></h3> <p>é¦–å…ˆï¼ŒV8 ä¼šæŠŠè¿™ä¸ªå‡½æ•°æ ‡è®°ä¸ºå¯æ¢å¤çš„ï¼Œæ„å‘³ç€æ‰§è¡Œå¯ä»¥è¢«æš‚åœå¹¶æ¢å¤ï¼ˆä» <code>await</code> è§’åº¦çœ‹æ˜¯è¿™æ ·çš„ï¼‰ã€‚ç„¶åï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ‰€è°“çš„ <code>implicit_promise</code>ï¼ˆç”¨äºæŠŠ async å‡½æ•°é‡Œäº§ç”Ÿçš„å€¼è½¬ä¸º promiseï¼‰ã€‚
<img src="https://img.alicdn.com/tfs/TB1knFmpCzqK1RjSZFLXXcn2XXa-960-469.svg" alt="image | left">
ç„¶åæ˜¯æœ‰æ„æ€çš„ä¸œè¥¿æ¥äº†ï¼šçœŸæ­£çš„ <code>await</code>ã€‚é¦–å…ˆï¼Œè·Ÿåœ¨ <code>await</code> åé¢çš„å€¼è¢«è½¬ä¸º promiseã€‚ç„¶åï¼Œå¤„ç†å‡½æ•°ä¼šç»‘å®šè¿™ä¸ª promise ç”¨äºåœ¨ promise å®Œæˆåæ¢å¤ä¸»å‡½æ•°ï¼Œæ­¤æ—¶ async å‡½æ•°è¢«æš‚åœäº†ï¼Œè¿”å› <code>implicit_promise</code> ç»™è°ƒç”¨è€…ã€‚ä¸€æ—¦ <code>promise</code> å®Œæˆäº†ï¼Œå‡½æ•°ä¼šæ¢å¤å¹¶æ‹¿åˆ°ä» <code>promise</code> å¾—åˆ°å€¼ <code>w</code>ï¼Œæœ€åï¼Œ<code>implicit_promise</code> ä¼šç”¨ <code>w</code> æ ‡è®°ä¸ºå·²æ¥å—ã€‚
ç®€å•è¯´ï¼Œ<code>await v</code> åˆå§‹åŒ–æ­¥éª¤æœ‰ä»¥ä¸‹ç»„æˆï¼š</p> <ol><li>æŠŠ <code>v</code> è½¬æˆä¸€ä¸ª promiseï¼ˆè·Ÿåœ¨ <code>await</code> åé¢çš„ï¼‰ã€‚</li> <li>ç»‘å®šå¤„ç†å‡½æ•°ç”¨äºåæœŸæ¢å¤ã€‚</li> <li>æš‚åœ async å‡½æ•°å¹¶è¿”å› <code>implicit_promise</code> ç»™æ‰ç”¨è€…ã€‚
æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹ï¼Œå‡è®¾ <code>await</code> åæ˜¯ä¸€ä¸ª promiseï¼Œä¸”æœ€ç»ˆå·²å®ŒæˆçŠ¶æ€çš„å€¼æ˜¯ <code>42</code>ã€‚ç„¶åï¼Œå¼•æ“ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>promise</code> å¹¶ä¸”æŠŠ <code>await</code> åçš„å€¼ä½œä¸º resolve çš„å€¼ã€‚å€ŸåŠ©æ ‡å‡†é‡Œçš„ <a href="https://tc39.github.io/ecma262/#sec-promiseresolvethenablejob" target="_blank" rel="noopener noreferrer">PromiseResolveThenableJob<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> è¿™äº› promise ä¼šè¢«æ”¾åˆ°ä¸‹ä¸ªå‘¨æœŸæ‰§è¡Œã€‚
<img src="https://img.alicdn.com/tfs/TB1RBXqppzqK1RjSZFCXXbbxVXa-813-542.svg" alt="image | left">
ç„¶åï¼Œå¼•æ“åˆ›å»ºäº†å¦ä¸€ä¸ªå«åš <code>throwaway</code> çš„ promiseã€‚ä¹‹æ‰€ä»¥å«è¿™ä¸ªåå­—ï¼Œå› ä¸ºæ²¡æœ‰å…¶å®ƒä¸œè¥¿é“¾è¿‡å®ƒï¼Œä»…ä»…æ˜¯å¼•æ“å†…éƒ¨ç”¨çš„ã€‚<code>throwaway</code> promise ä¼šé“¾åˆ°å«æœ‰æ¢å¤å¤„ç†å‡½æ•°çš„ <code>promise</code> ä¸Šã€‚è¿™é‡Œ <code>performPromiseThen</code> æ“ä½œå…¶å®å†…éƒ¨å°±æ˜¯ <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then" target="_blank" rel="noopener noreferrer">Promise.prototype.then()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚æœ€ç»ˆï¼Œè¯¥ async å‡½æ•°ä¼šæš‚åœï¼Œå¹¶æŠŠæ§åˆ¶æƒäº¤ç»™è°ƒç”¨è€…ã€‚
<img src="https://img.alicdn.com/tfs/TB1UzXqpsbpK1RjSZFyXXX_qFXa-813-542.svg" alt="image | left">
è°ƒç”¨è€…ä¼šç»§ç»­æ‰§è¡Œï¼Œæœ€ç»ˆè°ƒç”¨æ ˆä¼šæ¸…ç©ºï¼Œç„¶åå¼•æ“ä¼šå¼€å§‹æ‰§è¡Œå¾®ä»»åŠ¡ï¼šè¿è¡Œä¹‹å‰å·²å‡†å¤‡å°±ç»ªçš„ <a href="https://tc39.github.io/ecma262/#sec-promiseresolvethenablejob" target="_blank" rel="noopener noreferrer">PromiseResolveThenableJob<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ª <a href="https://tc39.github.io/ecma262/#sec-promisereactionjob" target="_blank" rel="noopener noreferrer">PromiseReactionJob<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œå®ƒçš„å·¥ä½œä»…ä»…æ˜¯åœ¨ä¼ é€’ç»™ <code>await</code> çš„å€¼ä¸Šå°è£…ä¸€å±‚ <code>promise</code>ã€‚ç„¶åï¼Œå¼•æ“å›åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå› ä¸ºåœ¨å›åˆ°äº‹ä»¶å¾ªç¯ä¹‹å‰å¾®ä»»åŠ¡é˜Ÿåˆ—å¿…é¡»è¦æ¸…ç©ºã€‚
<img src="https://img.alicdn.com/tfs/TB1goXGpxjaK1RjSZFAXXbdLFXa-813-542.svg" alt="image | left">
ç„¶åæ˜¯å¦ä¸€ä¸ª <a href="https://tc39.github.io/ecma262/#sec-promisereactionjob" target="_blank" rel="noopener noreferrer">PromiseReactionJob<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œç­‰å¾…æˆ‘ä»¬æ­£åœ¨ <code>await</code>ï¼ˆæˆ‘ä»¬è¿™é‡ŒæŒ‡çš„æ˜¯ <code>42</code>ï¼‰è¿™ä¸ª <code>promise</code> å®Œæˆï¼Œç„¶åæŠŠè¿™ä¸ªåŠ¨ä½œå®‰æ’åˆ° <code>throwaway</code> promise é‡Œã€‚å¼•æ“ç»§ç»­å›åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå› ä¸ºè¿˜æœ‰æœ€åä¸€ä¸ªå¾®ä»»åŠ¡ã€‚
<img src="https://img.alicdn.com/tfs/TB1.44wpAzoK1RjSZFlXXai4VXa-813-542.svg" alt="image | left">
ç°åœ¨è¿™ç¬¬äºŒä¸ª <a href="https://tc39.github.io/ecma262/#sec-promisereactionjob" target="_blank" rel="noopener noreferrer">PromiseReactionJob<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> æŠŠå†³å®šä¼ è¾¾ç»™ <code>throwaway</code> promiseï¼Œå¹¶æ¢å¤ async å‡½æ•°çš„æ‰§è¡Œï¼Œæœ€åè¿”å›ä» <code>await</code> å¾—åˆ°çš„ <code>42</code>ã€‚
<img src="https://img.alicdn.com/tfs/TB1WrXvpAvoK1RjSZFDXXXY3pXa-957-465.svg" alt="image | left">
æ€»ç»“ä¸‹ï¼Œå¯¹äºæ¯ä¸€ä¸ª <code>await</code> å¼•æ“éƒ½ä¼šåˆ›å»º__ä¸¤ä¸ªé¢å¤–__çš„ promiseï¼ˆå³ä½¿å³å€¼å·²ç»æ˜¯ä¸€ä¸ª promiseï¼‰ï¼Œå¹¶ä¸”éœ€è¦__è‡³å°‘ä¸‰ä¸ª__å¾®ä»»åŠ¡ã€‚è°ä¼šæƒ³åˆ°ä¸€ä¸ªç®€å•çš„ <code>await</code> ç«Ÿç„¶ä¼šæœ‰å¦‚æ­¤å¤šå†—ä½™çš„è¿ç®—ï¼Ÿï¼
<img src="https://img.alicdn.com/tfs/TB1kLlrpr2pK1RjSZFsXXaNlXXa-451-214.svg" alt="image | left">
æˆ‘ä»¬æ¥çœ‹çœ‹åˆ°åº•æ˜¯ä»€ä¹ˆå¼•èµ·å†—ä½™ã€‚ç¬¬ä¸€è¡Œçš„ä½œç”¨æ˜¯å°è£…ä¸€ä¸ª promiseï¼Œç¬¬äºŒè¡Œä¸ºäº† resolve å°è£…åçš„ promose <code>await</code> ä¹‹åçš„å€¼ <code>v</code>ã€‚è¿™ä¸¤è¡Œäº§ç”Ÿä¸ªå†—ä½™çš„ promise å’Œä¸¤ä¸ªå†—ä½™çš„å¾®ä»»åŠ¡ã€‚å¦‚æœ <code>v</code> å·²ç»æ˜¯ promise çš„è¯å°±å¾ˆä¸åˆ’ç®—äº†ï¼ˆå¤§å¤šæ—¶å€™ç¡®å®ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ã€‚åœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ <code>await</code> äº† <code>42</code> çš„è¯ï¼Œé‚£ç¡®å®è¿˜æ˜¯éœ€è¦å°è£…æˆ promise çš„ã€‚
å› æ­¤ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ <a href="https://tc39.github.io/ecma262/#sec-promise-resolve" target="_blank" rel="noopener noreferrer">promiseResolve<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> æ“ä½œæ¥å¤„ç†ï¼Œåªæœ‰å¿…è¦çš„æ—¶å€™æ‰ä¼šè¿›è¡Œ promise çš„å°è£…ï¼š
<img src="https://img.alicdn.com/tfs/TB1bk0TpyLaK1RjSZFxXXamPFXa-949-376.svg" alt="image | left">
å¦‚æœå…¥å‚æ˜¯ promiseï¼Œåˆ™åŸå°ä¸åŠ¨åœ°è¿”å›ï¼Œåªå°è£…å¿…è¦çš„ promiseã€‚è¿™ä¸ªæ“ä½œåœ¨å€¼å·²ç»æ˜¯ promose çš„æƒ…å†µä¸‹å¯ä»¥çœå»ä¸€ä¸ªé¢å¤–çš„ promise å’Œä¸¤ä¸ªå¾®ä»»åŠ¡ã€‚æ­¤ç‰¹æ€§å¯ä»¥é€šè¿‡ <code>--harmony-await-optimization</code> å‚æ•°åœ¨ V8ï¼ˆä» v7.1 å¼€å§‹ï¼‰ä¸­å¼€å¯ï¼ŒåŒæ—¶æˆ‘ä»¬ <a href="https://github.com/tc39/ecma262/pull/1250" target="_blank" rel="noopener noreferrer">å‘ ECMAScript å‘èµ·äº†ä¸€ä¸ªææ¡ˆ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œç›®æµ‹å¾ˆå¿«ä¼šåˆå¹¶ã€‚
ä¸‹é¢æ˜¯ç®€åŒ–åçš„ <code>await</code> æ‰§è¡Œè¿‡ç¨‹ï¼š
<img src="https://img.alicdn.com/tfs/TB1mLNnpCzqK1RjSZPcXXbTepXa-792-545.svg" alt="image | left">
æ„Ÿè°¢ç¥å¥‡çš„ <a href="https://tc39.github.io/ecma262/#sec-promise-resolve" target="_blank" rel="noopener noreferrer">promiseResolve<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦ä¼  <code>v</code> å³å¯è€Œä¸ç”¨å…³å¿ƒå®ƒæ˜¯ä»€ä¹ˆã€‚ä¹‹åè·Ÿä¹‹å‰ä¸€æ ·ï¼Œå¼•æ“ä¼šåˆ›å»ºä¸€ä¸ª <code>throwaway</code> promise å¹¶æ”¾åˆ° <a href="https://tc39.github.io/ecma262/#sec-promisereactionjob" target="_blank" rel="noopener noreferrer">PromiseReactionJob<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> é‡Œä¸ºäº†åœ¨ä¸‹ä¸€ä¸ª tick æ—¶æ¢å¤è¯¥ async å‡½æ•°ï¼Œå®ƒä¼šå…ˆæš‚åœå‡½æ•°ï¼ŒæŠŠè‡ªèº«è¿”å›ç»™æ‰ç”¨è€…ã€‚
<img src="https://img.alicdn.com/tfs/TB1LjtqppYqK1RjSZLeXXbXppXa-648-548.svg" alt="image | left">
å½“æœ€åæ‰€æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œå¼•æ“ä¼šè·‘å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¼šæ‰§è¡Œ <a href="https://tc39.github.io/ecma262/#sec-promisereactionjob" target="_blank" rel="noopener noreferrer">PromiseReactionJob<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚è¿™ä¸ªä»»åŠ¡ä¼šä¼ é€’ <code>promise</code> ç»“æœç»™ <code>throwaway</code>ï¼Œå¹¶ä¸”æ¢å¤ async å‡½æ•°ï¼Œä» <code>await</code> æ‹¿åˆ° <code>42</code>ã€‚
<img src="https://img.alicdn.com/tfs/TB11X4rpBLoK1RjSZFuXXXn0XXa-955-383.svg" alt="image | left">
å°½ç®¡æ˜¯å†…éƒ¨ä½¿ç”¨ï¼Œå¼•æ“åˆ›å»º <code>throwaway</code> promise å¯èƒ½è¿˜æ˜¯ä¼šè®©äººè§‰å¾—å“ªé‡Œä¸å¯¹ã€‚äº‹å®è¯æ˜ï¼Œ<code>throwaway</code> promise ä»…ä»…æ˜¯ä¸ºäº†æ»¡è¶³è§„èŒƒé‡Œ <code>performPromiseThen</code> çš„éœ€è¦ã€‚
<img src="https://img.alicdn.com/tfs/TB1P84xpsfpK1RjSZFOXXa6nFXa-936-198.svg" alt="image | left">
è¿™æ˜¯æœ€è¿‘æè®®ç»™ ECMAScript çš„ <a href="https://github.com/tc39/ecma262/issues/694" target="_blank" rel="noopener noreferrer">å˜æ›´<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œå¼•æ“å¤§å¤šæ•°æ—¶å€™ä¸å†éœ€è¦åˆ›å»º <code>throwaway</code> äº†ã€‚
<img src="https://img.alicdn.com/tfs/TB1wYFVpyLaK1RjSZFxXXamPFXa-939-355.svg" alt="image | left">
å¯¹æ¯” <code>await</code> åœ¨ Node.js 10 å’Œä¼˜åŒ–åï¼ˆåº”è¯¥ä¼šæ”¾åˆ° Node.js 12 ä¸Šï¼‰çš„è¡¨ç°ï¼š
<img src="https://img.alicdn.com/tfs/TB1bBhxprvpK1RjSZPiXXbmwXXa-600-371.svg" alt="image | left"> <strong><code>async</code></strong><strong>/</strong><strong><code>await</code></strong><strong> æ€§èƒ½è¶…è¿‡äº†æ‰‹å†™çš„ promise ä»£ç </strong>ã€‚å…³é”®å°±æ˜¯æˆ‘ä»¬å‡å°‘äº† async å‡½æ•°é‡Œä¸€äº›ä¸å¿…è¦çš„å¼€é”€ï¼Œä¸ä»…ä»…æ˜¯ V8 å¼•æ“ï¼Œå…¶å®ƒ JavaScript å¼•æ“éƒ½é€šè¿‡è¿™ä¸ª <a href="https://github.com/tc39/ecma262/pull/1250" target="_blank" rel="noopener noreferrer">è¡¥ä¸<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> å®ç°äº†ä¼˜åŒ–ã€‚</li></ol> <h2 id="å¼€å‘ä½“éªŒä¼˜åŒ–"><a href="#å¼€å‘ä½“éªŒä¼˜åŒ–" aria-hidden="true" class="header-anchor">#</a> å¼€å‘ä½“éªŒä¼˜åŒ–</h2> <p>é™¤äº†æ€§èƒ½ï¼ŒJavaScript å¼€å‘è€…ä¹Ÿå¾ˆå…³å¿ƒé—®é¢˜å®šä½å’Œä¿®å¤ï¼Œè¿™åœ¨å¼‚æ­¥ä»£ç é‡Œä¸€ç›´ä¸æ˜¯ä»¶å®¹æ˜“çš„äº‹ã€‚<a href="https://developers.google.com/web/tools/chrome-devtools" target="_blank" rel="noopener noreferrer">Chrome DevTools<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ç°åœ¨æ”¯æŒäº†å¼‚æ­¥æ ˆè¿½è¸ªï¼š
<img src="https://img.alicdn.com/tfs/TB1gZlwpCzqK1RjSZFHXXb3CpXa-877-369.png" alt="image | left">
åœ¨æœ¬åœ°å¼€å‘æ—¶è¿™æ˜¯ä¸ªå¾ˆæœ‰ç”¨çš„ç‰¹æ€§ï¼Œä¸è¿‡ä¸€æ—¦åº”ç”¨éƒ¨ç½²äº†å°±æ²¡å•¥ç”¨äº†ã€‚è°ƒè¯•æ—¶ï¼Œä½ åªèƒ½çœ‹åˆ°æ—¥å¿—æ–‡ä»¶é‡Œçš„ <code>Error#stack</code> ä¿¡æ¯ï¼Œè¿™äº›å¹¶ä¸ä¼šåŒ…å«ä»»ä½•å¼‚æ­¥ä¿¡æ¯ã€‚
æœ€è¿‘æˆ‘ä»¬æçš„ <a href="https://bit.ly/v8-zero-cost-async-stack-traces" target="_blank" rel="noopener noreferrer">é›¶æˆæœ¬å¼‚æ­¥æ ˆè¿½è¸ª<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ä½¿å¾— <code>Error#stack</code> åŒ…å«äº† async å‡½æ•°çš„è°ƒç”¨ä¿¡æ¯ã€‚ã€Œé›¶æˆæœ¬ã€å¬èµ·æ¥å¾ˆè®©äººå…´å¥‹ï¼Œå¯¹å§ï¼Ÿå½“ Chrome DevTools åŠŸèƒ½å¸¦æ¥é‡å¤§å¼€é”€æ—¶ï¼Œå®ƒå¦‚ä½•æ‰èƒ½å®ç°é›¶æˆæœ¬ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œ<code>foo</code> é‡Œè°ƒç”¨ <code>bar</code>ï¼Œ<code>bar</code> åœ¨ await ä¸€ä¸ª promise åæŠ›ä¸€ä¸ªå¼‚å¸¸ï¼š</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'BEEP BEEP'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>è¿™æ®µä»£ç åœ¨ Node.js 8 æˆ– Node.js 10 è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ node index.js
Error: BEEP BEEP
    at bar <span class="token punctuation">(</span>index.js:8:9<span class="token punctuation">)</span>
    at process._tickCallback <span class="token punctuation">(</span>internal/process/next_tick.js:68:7<span class="token punctuation">)</span>
    at Function.Module.runMain <span class="token punctuation">(</span>internal/modules/cjs/loader.js:745:11<span class="token punctuation">)</span>
    at startup <span class="token punctuation">(</span>internal/bootstrap/node.js:266:19<span class="token punctuation">)</span>
    at bootstrapNodeJSCore <span class="token punctuation">(</span>internal/bootstrap/node.js:595:3<span class="token punctuation">)</span>
</code></pre></div><p>æ³¨æ„åˆ°ï¼Œå°½ç®¡æ˜¯ <code>foo()</code> é‡Œçš„è°ƒç”¨æŠ›çš„é”™ï¼Œ<code>foo</code> æœ¬èº«å´ä¸åœ¨æ ˆè¿½è¸ªä¿¡æ¯é‡Œã€‚å¦‚æœåº”ç”¨æ˜¯éƒ¨ç½²åœ¨äº‘å®¹å™¨é‡Œï¼Œè¿™ä¼šè®©å¼€å‘è€…å¾ˆéš¾å»å®šä½é—®é¢˜ã€‚
æœ‰æ„æ€çš„æ˜¯ï¼Œå¼•æ“æ˜¯çŸ¥é“ <code>bar</code> ç»“æŸååº”è¯¥ç»§ç»­æ‰§è¡Œä»€ä¹ˆçš„ï¼šå³ <code>foo</code> å‡½æ•°é‡Œ <code>await</code> åã€‚æ°å¥½ï¼Œè¿™é‡Œä¹Ÿæ­£æ˜¯ <code>foo</code> æš‚åœçš„åœ°æ–¹ã€‚å¼•æ“å¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯é‡å»ºå¼‚æ­¥çš„æ ˆè¿½è¸ªä¿¡æ¯ã€‚æœ‰äº†ä»¥ä¸Šä¼˜åŒ–ï¼Œè¾“å‡ºå°±ä¼šå˜æˆè¿™æ ·ï¼š</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ node --async-stack-traces index.js
Error: BEEP BEEP
    at bar <span class="token punctuation">(</span>index.js:8:9<span class="token punctuation">)</span>
    at process._tickCallback <span class="token punctuation">(</span>internal/process/next_tick.js:68:7<span class="token punctuation">)</span>
    at Function.Module.runMain <span class="token punctuation">(</span>internal/modules/cjs/loader.js:745:11<span class="token punctuation">)</span>
    at startup <span class="token punctuation">(</span>internal/bootstrap/node.js:266:19<span class="token punctuation">)</span>
    at bootstrapNodeJSCore <span class="token punctuation">(</span>internal/bootstrap/node.js:595:3<span class="token punctuation">)</span>
    at async foo <span class="token punctuation">(</span>index.js:2:3<span class="token punctuation">)</span>
</code></pre></div><p>åœ¨æ ˆè¿½è¸ªä¿¡æ¯é‡Œï¼Œæœ€ä¸Šå±‚çš„å‡½æ•°å‡ºç°åœ¨ç¬¬ä¸€ä¸ªï¼Œä¹‹åæ˜¯ä¸€äº›å¼‚æ­¥è°ƒç”¨æ ˆï¼Œå†åé¢æ˜¯ <code>foo</code> é‡Œé¢ <code>bar</code> ä¸Šä¸‹æ–‡çš„æ ˆä¿¡æ¯ã€‚è¿™ä¸ªç‰¹æ€§çš„å¯ç”¨å¯ä»¥é€šè¿‡ V8 çš„ <code>--async-stack-traces</code> å‚æ•°å¯ç”¨ã€‚
ç„¶è€Œï¼Œå¦‚æœä½ è·Ÿä¸Šé¢ Chrome DevTools é‡Œçš„æ ˆä¿¡æ¯å¯¹æ¯”ï¼Œä½ ä¼šå‘ç°æ ˆè¿½è¸ªé‡Œå¼‚æ­¥éƒ¨åˆ†ç¼ºå¤±äº† <code>foo</code> çš„è°ƒç”¨ç‚¹ä¿¡æ¯ã€‚è¿™é‡Œåˆ©ç”¨äº† <code>await</code> æ¢å¤å’Œæš‚åœä½ç½®æ˜¯ä¸€æ ·çš„ç‰¹æ€§ï¼Œä½† <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then" target="_blank" rel="noopener noreferrer">Promise#then()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> æˆ– <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch" target="_blank" rel="noopener noreferrer">Promise#catch()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> å°±ä¸æ˜¯è¿™æ ·çš„ã€‚å¯ä»¥çœ‹ Mathias Bynens çš„æ–‡ç«  <a href="https://mathiasbynens.be/notes/async-stack-traces" target="_blank" rel="noopener noreferrer">await beats Promise#then()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> äº†è§£æ›´å¤šã€‚</p> <h2 id="ç»“è®º"><a href="#ç»“è®º" aria-hidden="true" class="header-anchor">#</a> ç»“è®º</h2> <p>async å‡½æ•°å˜å¿«å°‘ä¸äº†ä»¥ä¸‹ä¸¤ä¸ªä¼˜åŒ–ï¼š</p> <ul><li>ç§»é™¤äº†é¢å¤–çš„ä¸¤ä¸ªå¾®ä»»åŠ¡</li> <li>ç§»é™¤äº† <code>throwaway</code> promise
é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬é€šè¿‡ <a href="https://bit.ly/v8-zero-cost-async-stack-traces" target="_blank" rel="noopener noreferrer">é›¶æˆæœ¬å¼‚æ­¥æ ˆè¿½è¸ª<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> æå‡äº† <code>await</code> å’Œ <code>Promise.all()</code> å¼€å‘è°ƒè¯•ä½“éªŒã€‚
æˆ‘ä»¬è¿˜æœ‰äº›å¯¹ JavaScript å¼€å‘è€…å‹å¥½çš„æ€§èƒ½å»ºè®®ï¼š
å¤šä½¿ç”¨ <code>async</code> å’Œ <code>await</code> è€Œä¸æ˜¯æ‰‹å†™ promise ä»£ç ï¼Œå¤šä½¿ç”¨ JavaScript å¼•æ“æä¾›çš„ promise è€Œä¸æ˜¯è‡ªå·±å»å®ç°ã€‚</li></ul> <blockquote><p>æ–‡ç« å¯éšæ„è½¬è½½ï¼Œä½†è¯·ä¿ç•™æ­¤ <a href="https://www.yuque.com/es2049/blog" target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚
éå¸¸æ¬¢è¿æœ‰æ¿€æƒ…çš„ä½ åŠ å…¥ <a href="https://es2049.studio/" target="_blank" rel="noopener noreferrer">ES2049 Studio<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œç®€å†è¯·å‘é€è‡³ caijun.hcj(at)<a href="http://alibaba-inc.com" target="_blank" rel="noopener noreferrer">alibaba-inc.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ã€‚</p></blockquote></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pixijs-101.html" class="prev">
          PixiJS 101
        </a></span> <span class="next"><a href="/prototype-review.html">
          Prototype Review
        </a>
        â†’
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.f42c0b44.js" defer></script><script src="/assets/js/31.bc58c029.js" defer></script>
  </body>
</html>
