(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{180:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),a("p",[a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1XkgupxjaK1RjSZKzXXXVwXXa-800-450.png",alt:"image | left"}}),t._v("\n翻译自："),a("a",{attrs:{href:"https://v8.dev/blog/fast-async",target:"_blank",rel:"noopener noreferrer"}},[t._v("Faster async functions and promises"),a("OutboundLink")],1),t._v("\nJavaScript 的异步过程一直被认为是不够快的，更糟糕的是，在 NodeJS 等实时性要求高的场景下调试堪比噩梦。不过，这一切正在改变，这篇文章会详细解释我们是如何优化 V8 引擎（也会涉及一些其它引擎）里的 async 函数和 promises 的，以及伴随着的开发体验的优化。\n"),a("strong",[t._v("温馨提示：")]),t._v(" 这里有个 "),a("a",{attrs:{href:"https://www.youtube.com/watch?v=DFP5DKDQfOc",target:"_blank",rel:"noopener noreferrer"}},[t._v("视频"),a("OutboundLink")],1),t._v("，你可以结合着文章看。")]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),a("p",[t._v("在 promises 正式成为 JavaScript 标准的一部分之前，回调被大量用在异步编程中，下面是个例子：")]),t._v(" "),t._m(3),a("p",[t._v("类似以上深度嵌套的回调通常被称为「回调黑洞」，因为它让代码可读性变差且不易维护。\n幸运地是，现在 promises 成为了 JavaScript 语言的一部分，以下实现了跟上面同样的功能：")]),t._v(" "),t._m(4),a("p",[t._v("最近，JavaScript 支持了 "),a("a",{attrs:{href:"https://developers.google.com/web/fundamentals/primers/async-functions",target:"_blank",rel:"noopener noreferrer"}},[t._v("async 函数"),a("OutboundLink")],1),t._v("，上面的异步代码可以写成像下面这样的同步的代码：")]),t._v(" "),t._m(5),a("p",[t._v("借助 async 函数，代码变得更简洁，代码的逻辑和数据流都变得更可控，当然其实底层实现还是异步。（注意，JavaScript 还是单线程执行，async 函数并不会开新的线程。）")]),t._v(" "),t._m(6),t._v(" "),a("p",[t._v("NodeJS 里 "),a("a",{attrs:{href:"https://nodejs.org/api/stream.html#stream_readable_streams",target:"_blank",rel:"noopener noreferrer"}},[t._v("ReadableStreams"),a("OutboundLink")],1),t._v(" 作为另一种形式的异步也特别常见，下面是个例子：")]),t._v(" "),t._m(7),a("p",[t._v("这段代码有一点难理解：只能通过回调去拿 chunks 里的数据流，而且数据流的结束也必须在回调里处理。如果你没能理解到函数是立即结束但实际处理必须在回调里进行，可能就会引入 bug。\n同样很幸运，ES2018 特性里引入的一个很酷的 "),a("a",{attrs:{href:"http://2ality.com/2016/10/asynchronous-iteration.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("async 迭代器"),a("OutboundLink")],1),t._v(" 可以简化上面的代码：")]),t._v(" "),t._m(8),t._m(9),t._v(" "),t._m(10),t._v(" "),a("p",[t._v("从 V8 v5.5 (Chrome 55 & Node.js 7) 到 V8 v6.8 (Chrome 68 & Node.js 10)，我们致力于异步代码的性能优化，目前的效果还不错，你可以放心地使用这些新特性。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1LLxkpxTpK1RjSZFMXXbG_VXa-600-371.svg",alt:"image | left"}}),t._v("\n上面的是 "),a("a",{attrs:{href:"https://github.com/v8/promise-performance-tests/blob/master/lib/doxbee-async.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("doxbee 基准测试"),a("OutboundLink")],1),t._v("，用于反应重度使用 promise 的性能，图中纵坐标表示执行时间，所以越小越好。\n另一方面，"),a("a",{attrs:{href:"https://github.com/v8/promise-performance-tests/blob/master/lib/parallel-async.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("parallel 基准测试"),a("OutboundLink")],1),t._v(" 反应的是重度使用 "),a("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all",target:"_blank",rel:"noopener noreferrer"}},[t._v("Promise.all()"),a("OutboundLink")],1),t._v(" 的性能情况，结果如下：\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1ShxdpwDqK1RjSZSyXXaxEVXa-600-371.svg",alt:"image | left"}}),t._v(" "),a("code",[t._v("Promise.all")]),t._v(" 的性能提高了__八倍__！\n然后，上面的测试仅仅是小的 DEMO 级别的测试，V8 团队更关心的是 "),a("a",{attrs:{href:"https://v8.dev/blog/real-world-performance",target:"_blank",rel:"noopener noreferrer"}},[t._v("实际用户代码的优化效果"),a("OutboundLink")],1),t._v("。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1uqJlpAzoK1RjSZFlXXai4VXa-600-371.svg",alt:"image | left"}}),t._v("\n上面是基于市场上流行的 HTTP 框架做的测试，这些框架大量使用了 promises 和 "),a("code",[t._v("async")]),t._v(" 函数，这个表展示的是每秒请求数，所以跟之前的表不一样，这个是数值越大越好。从表可以看出，从 Node.js 7 (V8 v5.5) 到 Node.js 10 (V8 v6.8) 性能提升了不少。\n性能提升取决于以下三个因素：")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://v8.dev/docs/turbofan",target:"_blank",rel:"noopener noreferrer"}},[t._v("TurboFan"),a("OutboundLink")],1),t._v("，新的优化编译器 🎉")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://v8.dev/blog/orinoco",target:"_blank",rel:"noopener noreferrer"}},[t._v("Orinoco"),a("OutboundLink")],1),t._v("，新的垃圾回收器 🚛")]),t._v(" "),a("li",[t._v("一个 Node.js 8 的 bug 导致 await 跳过了一些微 tick（microticks） 🐛\n当我们在 "),a("a",{attrs:{href:"https://medium.com/the-node-js-collection/node-js-8-3-0-is-now-available-shipping-with-the-ignition-turbofan-execution-pipeline-aa5875ad3367",target:"_blank",rel:"noopener noreferrer"}},[t._v("Node.js 8"),a("OutboundLink")],1),t._v(" 里 "),a("a",{attrs:{href:"https://v8.dev/blog/launching-ignition-and-turbofan",target:"_blank",rel:"noopener noreferrer"}},[t._v("启用 TurboFan"),a("OutboundLink")],1),t._v(" 的后，性能得到了巨大的提升。\n同时我们引入了一个新的垃圾回收器，叫作 Orinoco，它把垃圾回收从主线程中移走，因此对请求响应速度提升有很大帮助。\n最后，Node.js 8 中引入了一个 bug 在某些时候会让 "),a("code",[t._v("await")]),t._v(" 跳过一些微 tick，这反而让性能变好了。这个 bug 是因为无意中违反了规范导致的，但是却给了我们优化的一些思路。这里我们稍微解释下：")])]),t._v(" "),t._m(11),t._m(12),t._v(" "),t._m(13),t._v(" "),a("p",[t._v("从某层面上来说，JavaScript 里存在任务和微任务。任务处理 I/O 和计时器等事件，一次只处理一个。微任务是为了 "),a("code",[t._v("async")]),t._v("/"),a("code",[t._v("await")]),t._v(" 和 promise 的延迟执行设计的，每次任务最后执行。在返回事件循环（event loop）前，微任务的队列会被清空。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1IXhnpxTpK1RjSZFKXXa2wXXa-832-286.svg",alt:"image | left"}}),t._v("\n可以通过 Jake Archibald 的 "),a("a",{attrs:{href:"https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/",target:"_blank",rel:"noopener noreferrer"}},[t._v("tasks, microtasks, queues, and schedules in the browser"),a("OutboundLink")],1),t._v(" 了解更多。Node.js 里任务模型与此非常类似。")]),t._v(" "),t._m(14),t._v(" "),a("p",[t._v("根据 MDN，async 函数是一个通过异步执行并隐式返回 promise 作为结果的函数。从开发者角度看，async 函数让异步代码看起来像同步代码。\n一个最简单的 async 函数：")]),t._v(" "),t._m(15),a("p",[t._v("函数执行后会返回一个 promise，你可以像使用其它 promise 一样用其返回的值。")]),t._v(" "),t._m(16),t._m(17),t._v(" "),t._m(18),t._m(19),t._v(" "),t._m(20),t._m(21),t._v(" "),t._m(22),t._m(23),t._v(" "),t._m(24),a("p",[t._v("更有趣的是，"),a("code",[t._v("await")]),t._v(" 后可以跟任何 "),a("a",{attrs:{href:"https://promisesaplus.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("“thenable”"),a("OutboundLink")],1),t._v("，例如任何含有 "),a("code",[t._v("then")]),t._v(" 方法的对象，就算不是 promise 都可以。因此你可以实现一个有意思的 类来记录执行时间的消耗：")]),t._v(" "),t._m(25),a("p",[t._v("一起来看看 V8 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#await",target:"_blank",rel:"noopener noreferrer"}},[t._v("规范"),a("OutboundLink")],1),t._v(" 里是如何处理 "),a("code",[t._v("await")]),t._v(" 的。下面是很简单的 async 函数 "),a("code",[t._v("foo")]),t._v("：")]),t._v(" "),t._m(26),t._m(27),t._v(" "),t._m(28),t._v(" "),t._m(29),t._v(" "),a("ol",[t._m(30),t._v(" "),a("li",[t._v("绑定处理函数用于后期恢复。")]),t._v(" "),a("li",[t._v("暂停 async 函数并返回 "),a("code",[t._v("implicit_promise")]),t._v(" 给掉用者。\n我们一步步来看，假设 "),a("code",[t._v("await")]),t._v(" 后是一个 promise，且最终已完成状态的值是 "),a("code",[t._v("42")]),t._v("。然后，引擎会创建一个新的 "),a("code",[t._v("promise")]),t._v(" 并且把 "),a("code",[t._v("await")]),t._v(" 后的值作为 resolve 的值。借助标准里的 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#sec-promiseresolvethenablejob",target:"_blank",rel:"noopener noreferrer"}},[t._v("PromiseResolveThenableJob"),a("OutboundLink")],1),t._v(" 这些 promise 会被放到下个周期执行。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1RBXqppzqK1RjSZFCXXbbxVXa-813-542.svg",alt:"image | left"}}),t._v("\n然后，引擎创建了另一个叫做 "),a("code",[t._v("throwaway")]),t._v(" 的 promise。之所以叫这个名字，因为没有其它东西链过它，仅仅是引擎内部用的。"),a("code",[t._v("throwaway")]),t._v(" promise 会链到含有恢复处理函数的 "),a("code",[t._v("promise")]),t._v(" 上。这里 "),a("code",[t._v("performPromiseThen")]),t._v(" 操作其实内部就是 "),a("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then",target:"_blank",rel:"noopener noreferrer"}},[t._v("Promise.prototype.then()"),a("OutboundLink")],1),t._v("。最终，该 async 函数会暂停，并把控制权交给调用者。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1UzXqpsbpK1RjSZFyXXX_qFXa-813-542.svg",alt:"image | left"}}),t._v("\n调用者会继续执行，最终调用栈会清空，然后引擎会开始执行微任务：运行之前已准备就绪的 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#sec-promiseresolvethenablejob",target:"_blank",rel:"noopener noreferrer"}},[t._v("PromiseResolveThenableJob"),a("OutboundLink")],1),t._v("，首先是一个 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#sec-promisereactionjob",target:"_blank",rel:"noopener noreferrer"}},[t._v("PromiseReactionJob"),a("OutboundLink")],1),t._v("，它的工作仅仅是在传递给 "),a("code",[t._v("await")]),t._v(" 的值上封装一层 "),a("code",[t._v("promise")]),t._v("。然后，引擎回到微任务队列，因为在回到事件循环之前微任务队列必须要清空。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1goXGpxjaK1RjSZFAXXbdLFXa-813-542.svg",alt:"image | left"}}),t._v("\n然后是另一个 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#sec-promisereactionjob",target:"_blank",rel:"noopener noreferrer"}},[t._v("PromiseReactionJob"),a("OutboundLink")],1),t._v("，等待我们正在 "),a("code",[t._v("await")]),t._v("（我们这里指的是 "),a("code",[t._v("42")]),t._v("）这个 "),a("code",[t._v("promise")]),t._v(" 完成，然后把这个动作安排到 "),a("code",[t._v("throwaway")]),t._v(" promise 里。引擎继续回到微任务队列，因为还有最后一个微任务。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1.44wpAzoK1RjSZFlXXai4VXa-813-542.svg",alt:"image | left"}}),t._v("\n现在这第二个 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#sec-promisereactionjob",target:"_blank",rel:"noopener noreferrer"}},[t._v("PromiseReactionJob"),a("OutboundLink")],1),t._v(" 把决定传达给 "),a("code",[t._v("throwaway")]),t._v(" promise，并恢复 async 函数的执行，最后返回从 "),a("code",[t._v("await")]),t._v(" 得到的 "),a("code",[t._v("42")]),t._v("。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1WrXvpAvoK1RjSZFDXXXY3pXa-957-465.svg",alt:"image | left"}}),t._v("\n总结下，对于每一个 "),a("code",[t._v("await")]),t._v(" 引擎都会创建__两个额外__的 promise（即使右值已经是一个 promise），并且需要__至少三个__微任务。谁会想到一个简单的 "),a("code",[t._v("await")]),t._v(" 竟然会有如此多冗余的运算？！\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1kLlrpr2pK1RjSZFsXXaNlXXa-451-214.svg",alt:"image | left"}}),t._v("\n我们来看看到底是什么引起冗余。第一行的作用是封装一个 promise，第二行为了 resolve 封装后的 promose "),a("code",[t._v("await")]),t._v(" 之后的值 "),a("code",[t._v("v")]),t._v("。这两行产生个冗余的 promise 和两个冗余的微任务。如果 "),a("code",[t._v("v")]),t._v(" 已经是 promise 的话就很不划算了（大多时候确实也是如此）。在某些特殊场景 "),a("code",[t._v("await")]),t._v(" 了 "),a("code",[t._v("42")]),t._v(" 的话，那确实还是需要封装成 promise 的。\n因此，这里可以使用 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#sec-promise-resolve",target:"_blank",rel:"noopener noreferrer"}},[t._v("promiseResolve"),a("OutboundLink")],1),t._v(" 操作来处理，只有必要的时候才会进行 promise 的封装：\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1bk0TpyLaK1RjSZFxXXamPFXa-949-376.svg",alt:"image | left"}}),t._v("\n如果入参是 promise，则原封不动地返回，只封装必要的 promise。这个操作在值已经是 promose 的情况下可以省去一个额外的 promise 和两个微任务。此特性可以通过 "),a("code",[t._v("--harmony-await-optimization")]),t._v(" 参数在 V8（从 v7.1 开始）中开启，同时我们 "),a("a",{attrs:{href:"https://github.com/tc39/ecma262/pull/1250",target:"_blank",rel:"noopener noreferrer"}},[t._v("向 ECMAScript 发起了一个提案"),a("OutboundLink")],1),t._v("，目测很快会合并。\n下面是简化后的 "),a("code",[t._v("await")]),t._v(" 执行过程：\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1mLNnpCzqK1RjSZPcXXbTepXa-792-545.svg",alt:"image | left"}}),t._v("\n感谢神奇的 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#sec-promise-resolve",target:"_blank",rel:"noopener noreferrer"}},[t._v("promiseResolve"),a("OutboundLink")],1),t._v("，现在我们只需要传 "),a("code",[t._v("v")]),t._v(" 即可而不用关心它是什么。之后跟之前一样，引擎会创建一个 "),a("code",[t._v("throwaway")]),t._v(" promise 并放到 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#sec-promisereactionjob",target:"_blank",rel:"noopener noreferrer"}},[t._v("PromiseReactionJob"),a("OutboundLink")],1),t._v(" 里为了在下一个 tick 时恢复该 async 函数，它会先暂停函数，把自身返回给掉用者。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1LjtqppYqK1RjSZLeXXbXppXa-648-548.svg",alt:"image | left"}}),t._v("\n当最后所有执行完毕，引擎会跑微任务队列，会执行 "),a("a",{attrs:{href:"https://tc39.github.io/ecma262/#sec-promisereactionjob",target:"_blank",rel:"noopener noreferrer"}},[t._v("PromiseReactionJob"),a("OutboundLink")],1),t._v("。这个任务会传递 "),a("code",[t._v("promise")]),t._v(" 结果给 "),a("code",[t._v("throwaway")]),t._v("，并且恢复 async 函数，从 "),a("code",[t._v("await")]),t._v(" 拿到 "),a("code",[t._v("42")]),t._v("。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB11X4rpBLoK1RjSZFuXXXn0XXa-955-383.svg",alt:"image | left"}}),t._v("\n尽管是内部使用，引擎创建 "),a("code",[t._v("throwaway")]),t._v(" promise 可能还是会让人觉得哪里不对。事实证明，"),a("code",[t._v("throwaway")]),t._v(" promise 仅仅是为了满足规范里 "),a("code",[t._v("performPromiseThen")]),t._v(" 的需要。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1P84xpsfpK1RjSZFOXXa6nFXa-936-198.svg",alt:"image | left"}}),t._v("\n这是最近提议给 ECMAScript 的 "),a("a",{attrs:{href:"https://github.com/tc39/ecma262/issues/694",target:"_blank",rel:"noopener noreferrer"}},[t._v("变更"),a("OutboundLink")],1),t._v("，引擎大多数时候不再需要创建 "),a("code",[t._v("throwaway")]),t._v(" 了。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1wYFVpyLaK1RjSZFxXXamPFXa-939-355.svg",alt:"image | left"}}),t._v("\n对比 "),a("code",[t._v("await")]),t._v(" 在 Node.js 10 和优化后（应该会放到 Node.js 12 上）的表现：\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1bBhxprvpK1RjSZPiXXbmwXXa-600-371.svg",alt:"image | left"}}),t._v(" "),t._m(31),a("strong",[t._v("/")]),t._m(32),a("strong",[t._v(" 性能超过了手写的 promise 代码")]),t._v("。关键就是我们减少了 async 函数里一些不必要的开销，不仅仅是 V8 引擎，其它 JavaScript 引擎都通过这个 "),a("a",{attrs:{href:"https://github.com/tc39/ecma262/pull/1250",target:"_blank",rel:"noopener noreferrer"}},[t._v("补丁"),a("OutboundLink")],1),t._v(" 实现了优化。")])]),t._v(" "),t._m(33),t._v(" "),a("p",[t._v("除了性能，JavaScript 开发者也很关心问题定位和修复，这在异步代码里一直不是件容易的事。"),a("a",{attrs:{href:"https://developers.google.com/web/tools/chrome-devtools",target:"_blank",rel:"noopener noreferrer"}},[t._v("Chrome DevTools"),a("OutboundLink")],1),t._v(" 现在支持了异步栈追踪：\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1gZlwpCzqK1RjSZFHXXb3CpXa-877-369.png",alt:"image | left"}}),t._v("\n在本地开发时这是个很有用的特性，不过一旦应用部署了就没啥用了。调试时，你只能看到日志文件里的 "),a("code",[t._v("Error#stack")]),t._v(" 信息，这些并不会包含任何异步信息。\n最近我们搞的 "),a("a",{attrs:{href:"https://bit.ly/v8-zero-cost-async-stack-traces",target:"_blank",rel:"noopener noreferrer"}},[t._v("零成本异步栈追踪"),a("OutboundLink")],1),t._v(" 使得 "),a("code",[t._v("Error#stack")]),t._v(" 包含了 async 函数的调用信息。「零成本」听起来很让人兴奋，对吧？当 Chrome DevTools 功能带来重大开销时，它如何才能实现零成本？举个例子，"),a("code",[t._v("foo")]),t._v(" 里调用 "),a("code",[t._v("bar")]),t._v("，"),a("code",[t._v("bar")]),t._v(" 在 await 一个 promise 后抛一个异常：")]),t._v(" "),t._m(34),a("p",[t._v("这段代码在 Node.js 8 或 Node.js 10 运行结果如下：")]),t._v(" "),t._m(35),t._m(36),t._v(" "),t._m(37),a("p",[t._v("在栈追踪信息里，最上层的函数出现在第一个，之后是一些异步调用栈，再后面是 "),a("code",[t._v("foo")]),t._v(" 里面 "),a("code",[t._v("bar")]),t._v(" 上下文的栈信息。这个特性的启用可以通过 V8 的 "),a("code",[t._v("--async-stack-traces")]),t._v(" 参数启用。\n然而，如果你跟上面 Chrome DevTools 里的栈信息对比，你会发现栈追踪里异步部分缺失了 "),a("code",[t._v("foo")]),t._v(" 的调用点信息。这里利用了 "),a("code",[t._v("await")]),t._v(" 恢复和暂停位置是一样的特性，但 "),a("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then",target:"_blank",rel:"noopener noreferrer"}},[t._v("Promise#then()"),a("OutboundLink")],1),t._v(" 或 "),a("a",{attrs:{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/catch",target:"_blank",rel:"noopener noreferrer"}},[t._v("Promise#catch()"),a("OutboundLink")],1),t._v(" 就不是这样的。可以看 Mathias Bynens 的文章 "),a("a",{attrs:{href:"https://mathiasbynens.be/notes/async-stack-traces",target:"_blank",rel:"noopener noreferrer"}},[t._v("await beats Promise#then()"),a("OutboundLink")],1),t._v(" 了解更多。")]),t._v(" "),t._m(38),t._v(" "),a("p",[t._v("async 函数变快少不了以下两个优化：")]),t._v(" "),a("ul",[a("li",[t._v("移除了额外的两个微任务")]),t._v(" "),a("li",[t._v("移除了 "),a("code",[t._v("throwaway")]),t._v(" promise\n除此之外，我们通过 "),a("a",{attrs:{href:"https://bit.ly/v8-zero-cost-async-stack-traces",target:"_blank",rel:"noopener noreferrer"}},[t._v("零成本异步栈追踪"),a("OutboundLink")],1),t._v(" 提升了 "),a("code",[t._v("await")]),t._v(" 和 "),a("code",[t._v("Promise.all()")]),t._v(" 开发调试体验。\n我们还有些对 JavaScript 开发者友好的性能建议：\n多使用 "),a("code",[t._v("async")]),t._v(" 和 "),a("code",[t._v("await")]),t._v(" 而不是手写 promise 代码，多使用 JavaScript 引擎提供的 promise 而不是自己去实现。")])]),t._v(" "),a("blockquote",[a("p",[t._v("文章可随意转载，但请保留此 "),a("a",{attrs:{href:"https://www.yuque.com/es2049/blog",target:"_blank",rel:"noopener noreferrer"}},[t._v("原文链接"),a("OutboundLink")],1),t._v("。\n非常欢迎有激情的你加入 "),a("a",{attrs:{href:"https://es2049.studio/",target:"_blank",rel:"noopener noreferrer"}},[t._v("ES2049 Studio"),a("OutboundLink")],1),t._v("，简历请发送至 caijun.hcj(at)"),a("a",{attrs:{href:"http://alibaba-inc.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("alibaba-inc.com"),a("OutboundLink")],1),t._v(" 。")])])])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"promise-optimization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#promise-optimization","aria-hidden":"true"}},[this._v("#")]),this._v(" Promise Optimization")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"异步编程的新方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#异步编程的新方案","aria-hidden":"true"}},[this._v("#")]),this._v(" 异步编程的新方案")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"从-callbacks-到-promises，再到-async-函数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#从-callbacks-到-promises，再到-async-函数","aria-hidden":"true"}},[this._v("#")]),this._v(" 从 callbacks 到 promises，再到 async 函数")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("done"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("validateParams")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("done")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dbQuery")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dbResults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("done")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("serviceCall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dbResults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" serviceResults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("done")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" serviceResults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("validateParams")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dbQuery"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("serviceCall"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("handler")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("validateParams")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" dbResults "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dbQuery")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" results "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("serviceCall")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dbResults"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("results"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" results"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"从事件监听回调到-async-迭代器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#从事件监听回调到-async-迭代器","aria-hidden":"true"}},[this._v("#")]),this._v(" 从事件监听回调到 async 迭代器")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" http "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nhttp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setEncoding")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'data'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("chunk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" chunk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'end'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1337")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" http "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nhttp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setEncoding")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'utf8'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" chunk "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("of")]),t._v(" req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" chunk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("statusCode "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1337")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("你可以把所有数据处理逻辑都放到一个 async 函数里使用 "),a("code",[t._v("for await…of")]),t._v(" 去迭代 chunks，而不是分别在 "),a("code",[t._v("'data'")]),t._v(" 和 "),a("code",[t._v("'end'")]),t._v(" 回调里处理，而且我们还加了 "),a("code",[t._v("try-catch")]),t._v(" 块来避免 "),a("code",[t._v("unhandledRejection")]),t._v(" 问题。\n以上这些特性你今天就可以在生成环境使用！async 函数__从 Node.js 8 (V8 v6.2 / Chrome 62) 开始就已全面支持__，async 迭代器__从 Node.js 10 (V8 v6.8 / Chrome 68) 开始支持__。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"async-性能优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#async-性能优化","aria-hidden":"true"}},[this._v("#")]),this._v(" async 性能优化")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" p "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'after:await'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\np"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tick:a'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tick:b'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("上面代码一开始创建了一个已经完成状态的 promise "),a("code",[t._v("p")]),t._v("，然后 "),a("code",[t._v("await")]),t._v(" 出其结果，又同时链了两个 "),a("code",[t._v("then")]),t._v("，那最终的 "),a("code",[t._v("console.log")]),t._v(" 打印的结果会是什么呢？\n因为 "),a("code",[t._v("p")]),t._v(" 是已完成的，你可能认为其会先打印 "),a("code",[t._v("'after:await'")]),t._v("，然后是剩下两个 "),a("code",[t._v("tick")]),t._v(", 事实上 Node.js 8 里的结果是：\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1H_FhpCzqK1RjSZPcXXbTepXa-959-445.svg",alt:"image | left"}}),t._v("\n虽然以上结果符合预期，但是却不符合规范。Node.js 10 纠正了这个行为，会先执行 "),a("code",[t._v("then")]),t._v(" 链里的，然后才是 async 函数。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1OthqpAvoK1RjSZFNXXcxMVXa-959-445.svg",alt:"image | left"}}),t._v("\n这个「正确的行为」看起来并不正常，甚至会让很多 JavaScript 开发者感到吃惊，还是有必要再详细解释下。在解释之前，我们先从一些基础开始。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"任务（tasks）vs-微任务（microtasks）"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#任务（tasks）vs-微任务（microtasks）","aria-hidden":"true"}},[this._v("#")]),this._v(" 任务（tasks）vs. 微任务（microtasks）")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"async-函数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#async-函数","aria-hidden":"true"}},[this._v("#")]),this._v(" async 函数")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("computeAnswer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("42")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" p "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("computeAnswer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// → Promise")]),t._v("\np"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// prints 42 on the next turn")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("你只能在下一个微任务执行后才能得到 promise "),s("code",[this._v("p")]),this._v(" 返回的值，换句话说，上面的代码语义上等价于使用 "),s("code",[this._v("Promise.resolve")]),this._v(" 得到的结果：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("computeAnswer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("42")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("async 函数真正强大的地方来源于 "),s("code",[this._v("await")]),this._v(" 表达式，它可以让一个函数执行暂停直到一个 promise 已接受（resolved），然后等到已完成（fulfilled）后恢复执行。已完成的 promise 会作为 "),s("code",[this._v("await")]),this._v(" 的值。这里的例子会解释这个行为：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetchStatus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" response "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[a("code",[t._v("fetchStatus")]),t._v(" 在遇到 "),a("code",[t._v("await")]),t._v(" 时会暂停，当 "),a("code",[t._v("fetch")]),t._v(" 这个 promise 已完成后会恢复执行，这跟直接链式处理 "),a("code",[t._v("fetch")]),t._v(" 返回的 promise 某种程度上等价。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetchStatus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("链式处理函数里包含了之前跟在 "),a("code",[t._v("await")]),t._v(" 后面的代码。\n正常来说你应该在 "),a("code",[t._v("await")]),t._v(" 后面放一个 "),a("code",[t._v("Promise")]),t._v("，不过其实后面可以跟任意 JavaScript 的值，如果跟的不是 promise，会被制转为 promise，所以 "),a("code",[t._v("await 42")]),t._v(" 效果如下：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" v "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("42")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" p "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// → Promise")]),t._v("\np"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// prints `42` eventually")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Sleep")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timeout "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resolve"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reject"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" startTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n               "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("timeout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" actualTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("actualTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" w "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" w"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("执行时，它把参数 "),s("code",[this._v("v")]),this._v(" 封装成一个 promise，然后会暂停直到 promise 完成，然后 "),s("code",[this._v("w")]),this._v(" 赋值为已完成的 promise，最后 async 返回了这个值。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"神秘的-await"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#神秘的-await","aria-hidden":"true"}},[this._v("#")]),this._v(" 神秘的 "),s("code",[this._v("await")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("首先，V8 会把这个函数标记为可恢复的，意味着执行可以被暂停并恢复（从 "),a("code",[t._v("await")]),t._v(" 角度看是这样的）。然后，会创建一个所谓的 "),a("code",[t._v("implicit_promise")]),t._v("（用于把 async 函数里产生的值转为 promise）。\n"),a("img",{attrs:{src:"https://img.alicdn.com/tfs/TB1knFmpCzqK1RjSZFLXXcn2XXa-960-469.svg",alt:"image | left"}}),t._v("\n然后是有意思的东西来了：真正的 "),a("code",[t._v("await")]),t._v("。首先，跟在 "),a("code",[t._v("await")]),t._v(" 后面的值被转为 promise。然后，处理函数会绑定这个 promise 用于在 promise 完成后恢复主函数，此时 async 函数被暂停了，返回 "),a("code",[t._v("implicit_promise")]),t._v(" 给调用者。一旦 "),a("code",[t._v("promise")]),t._v(" 完成了，函数会恢复并拿到从 "),a("code",[t._v("promise")]),t._v(" 得到值 "),a("code",[t._v("w")]),t._v("，最后，"),a("code",[t._v("implicit_promise")]),t._v(" 会用 "),a("code",[t._v("w")]),t._v(" 标记为已接受。\n简单说，"),a("code",[t._v("await v")]),t._v(" 初始化步骤有以下组成：")])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[this._v("把 "),s("code",[this._v("v")]),this._v(" 转成一个 promise（跟在 "),s("code",[this._v("await")]),this._v(" 后面的）。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("strong",[s("code",[this._v("async")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("strong",[s("code",[this._v("await")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"开发体验优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开发体验优化","aria-hidden":"true"}},[this._v("#")]),this._v(" 开发体验优化")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("42")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'BEEP BEEP'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stack"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ node index.js\nError: BEEP BEEP\n    at bar "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index.js:8:9"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at process._tickCallback "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internal/process/next_tick.js:68:7"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at Function.Module.runMain "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internal/modules/cjs/loader.js:745:11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at startup "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internal/bootstrap/node.js:266:19"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at bootstrapNodeJSCore "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internal/bootstrap/node.js:595:3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("注意到，尽管是 "),a("code",[t._v("foo()")]),t._v(" 里的调用抛的错，"),a("code",[t._v("foo")]),t._v(" 本身却不在栈追踪信息里。如果应用是部署在云容器里，这会让开发者很难去定位问题。\n有意思的是，引擎是知道 "),a("code",[t._v("bar")]),t._v(" 结束后应该继续执行什么的：即 "),a("code",[t._v("foo")]),t._v(" 函数里 "),a("code",[t._v("await")]),t._v(" 后。恰好，这里也正是 "),a("code",[t._v("foo")]),t._v(" 暂停的地方。引擎可以利用这些信息重建异步的栈追踪信息。有了以上优化，输出就会变成这样：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ node --async-stack-traces index.js\nError: BEEP BEEP\n    at bar "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index.js:8:9"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at process._tickCallback "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internal/process/next_tick.js:68:7"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at Function.Module.runMain "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internal/modules/cjs/loader.js:745:11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at startup "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internal/bootstrap/node.js:266:19"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at bootstrapNodeJSCore "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("internal/bootstrap/node.js:595:3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    at async foo "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index.js:2:3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"结论"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#结论","aria-hidden":"true"}},[this._v("#")]),this._v(" 结论")])}],!1,null,null,null);s.default=e.exports}}]);